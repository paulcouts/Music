<!DOCTYPE html>
<html>
<head>
  <title>Music App</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <!-- Use Goudy Old Style Bold if installed on the system -->
  <style>
    body {
      font-family: "Goudy Old Style Bold", "Goudy Old Style", serif;
    }
  </style>
</head>
<body>
  <!-- Top Navigation Bar -->
  <header class="top-nav">
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Search songs or artists...">
      <button onclick="searchVideos()">Search</button>
    </div>
    <div class="logo-container">
      <div class="logo">MyMusic</div>
      <div class="dropdown">
        <button class="dropdown-toggle">Menu</button>
        <ul class="dropdown-menu">
          <li><a href="/">Home</a></li>
          <li><a href="#">About</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </div>
    </div>
  </header>

  <!-- Player Area -->
  <div id="playerContainer">
    <div id="player">
      <p>Select a video to play</p>
    </div>
    <div id="songTitle">Not playing</div>
  </div>

  <!-- Home View: Recommended Videos -->
  <div class="home-container" id="homeContainer">
    <!-- Boxes injected dynamically -->
  </div>

  <!-- Search Results (initially hidden) -->
  <div id="searchResults" style="display: none;"></div>

  <script>
    // Load recommended videos with the default query "music"
    async function loadRecommendedVideos() {
      try {
        const response = await fetch('/search', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: 'query=' + encodeURIComponent('music')
        });
        const data = await response.json();
        if (data.error) {
          console.error(data.error);
          return;
        }
        // Shuffle and select 6 random videos
        const shuffled = data.sort(() => 0.5 - Math.random());
        const recommended = shuffled.slice(0, 6);
        const container = document.getElementById('homeContainer');
        container.innerHTML = '';
        recommended.forEach(video => {
          const box = document.createElement('div');
          box.className = 'home-box';
          box.innerHTML = `
            <img src="${video.thumbnail}" alt="${video.title}">
            <div class="box-info">
              <h3>${video.title}</h3>
            </div>
          `;
          box.onclick = () => playSong(video.videoId, video.title);
          container.appendChild(box);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // Play a video by injecting a YouTube iframe into the player area
    function playSong(videoId, title) {
      const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1`;
      document.getElementById('player').innerHTML = `
        <iframe width="640" height="390" 
                src="${embedUrl}" 
                title="${title}" 
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                referrerpolicy="strict-origin-when-cross-origin"
                allowfullscreen>
        </iframe>
      `;
      document.getElementById('songTitle').textContent = title;
    }

    // Search for videos and display results
    async function searchVideos() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      try {
        const response = await fetch('/search', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: 'query=' + encodeURIComponent(query)
        });
        const data = await response.json();
        document.getElementById('homeContainer').style.display = 'none';
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.style.display = 'flex';
        resultsContainer.innerHTML = '';
        const backBtn = document.createElement('button');
        backBtn.id = 'backBtn';
        backBtn.textContent = 'Back to Home';
        backBtn.onclick = showHome;
        resultsContainer.appendChild(backBtn);
        data.forEach(video => {
          const box = document.createElement('div');
          box.className = 'search-box';
          box.innerHTML = `
            <img src="${video.thumbnail}" alt="${video.title}">
            <h3>${video.title}</h3>
          `;
          box.onclick = () => playSong(video.videoId, video.title);
          resultsContainer.appendChild(box);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // Show the home view
    function showHome() {
      document.getElementById('homeContainer').style.display = 'flex';
      document.getElementById('searchResults').style.display = 'none';
      document.getElementById('searchInput').value = '';
    }

    // Initialize recommended videos on load
    loadRecommendedVideos();

    // Dropdown menu functionality
    document.addEventListener("DOMContentLoaded", function() {
      const dropdownToggle = document.querySelector('.dropdown-toggle');
      const dropdownMenu = document.querySelector('.dropdown-menu');
      dropdownToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdownMenu.classList.toggle('show');
      });
      document.addEventListener('click', function() {
        dropdownMenu.classList.remove('show');
      });
    });
  </script>
</body>
</html>
