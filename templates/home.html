<!DOCTYPE html>
<html>
<head>
  <title>Music App</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Top navigation bar with search -->
  <div class="top-nav">
    <input type="text" id="searchInput" placeholder="Search songs or artists...">
    <button onclick="searchVideos()">Search</button>
  </div>

  <!-- Home view: Recommended videos -->
  <div class="home-container" id="homeContainer">
    <div class="home-box" onclick="playSong('dQw4w9WgXcQ', 'Never Gonna Give You Up')">
      <img src="https://img.youtube.com/vi/dQw4w9WgXcQ/0.jpg" alt="Never Gonna Give You Up">
      <div class="box-info">
        <h3>Never Gonna Give You Up</h3>
        <p>Rick Astley</p>
      </div>
    </div>
    <div class="home-box" onclick="playSong('FTQbiNvZqaY', 'Africa')">
      <img src="https://img.youtube.com/vi/FTQbiNvZqaY/0.jpg" alt="Africa">
      <div class="box-info">
        <h3>Africa</h3>
        <p>Toto</p>
      </div>
    </div>
    <div class="home-box" onclick="playSong('djV11Xbc914', 'Take On Me')">
      <img src="https://img.youtube.com/vi/djV11Xbc914/0.jpg" alt="Take On Me">
      <div class="box-info">
        <h3>Take On Me</h3>
        <p>a-ha</p>
      </div>
    </div>
    <div class="home-box" onclick="playSong('Zi_XLOBDo_Y', 'Billie Jean')">
      <img src="https://img.youtube.com/vi/Zi_XLOBDo_Y/0.jpg" alt="Billie Jean">
      <div class="box-info">
        <h3>Billie Jean</h3>
        <p>Michael Jackson</p>
      </div>
    </div>
    <div class="home-box" onclick="playSong('JGwWNGJdvx8', 'Shape of You')">
      <img src="https://img.youtube.com/vi/JGwWNGJdvx8/0.jpg" alt="Shape of You">
      <div class="box-info">
        <h3>Shape of You</h3>
        <p>Ed Sheeran</p>
      </div>
    </div>
    <div class="home-box" onclick="playSong('OPf0YbXqDm0', 'Uptown Funk')">
      <img src="https://img.youtube.com/vi/OPf0YbXqDm0/0.jpg" alt="Uptown Funk">
      <div class="box-info">
        <h3>Uptown Funk</h3>
        <p>Bruno Mars</p>
      </div>
    </div>
  </div>

  <!-- Search results view (initially hidden) -->
  <div id="searchResults" style="display:none;"></div>

  <!-- Hidden YouTube player (audio only) -->
  <div id="hidden-video"></div>

  <!-- Bottom player bar -->
  <div class="player-bar">
    <div id="songTitle">Not playing</div>
    <input type="range" id="progressBar" value="0" min="0" max="100" style="width: 40%;">
    <button onclick="togglePlayPause()">Play/Pause</button>
  </div>

  <script>
    let player;
    let isPlaying = false;
    let progressTimer = null;

    function loadYouTubeAPI() {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    window.onYouTubeIframeAPIReady = function() {
      player = new YT.Player('hidden-video', {
        height: '90',
        width: '160',
        videoId: '',
        playerVars: {
          controls: 1,
          autoplay: 0,
          modestbranding: 1,
          showinfo: 0,
          rel: 0
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    };

    function onPlayerReady(event) {
      console.log("Player ready");
    }

    function onPlayerStateChange(event) {
      if (event.data === YT.PlayerState.PLAYING) {
        isPlaying = true;
        if (progressTimer) clearInterval(progressTimer);
        progressTimer = setInterval(updateProgressBar, 1000);
      } else {
        isPlaying = false;
        if (progressTimer) clearInterval(progressTimer);
      }
      if (event.data === YT.PlayerState.ENDED) {
        document.getElementById('progressBar').value = 0;
      }
    }

    function updateProgressBar() {
      if (player && player.getCurrentTime && player.getDuration) {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();
        if (duration > 0) {
          const progressPercent = (currentTime / duration) * 100;
          document.getElementById('progressBar').value = progressPercent;
        }
      }
    }

    function playSong(videoId, title) {
      if (player && typeof player.loadVideoById === 'function') {
        player.loadVideoById(videoId);
        setTimeout(() => {
          player.playVideo();
        }, 500);
        document.getElementById('songTitle').textContent = title;
        document.getElementById('progressBar').value = 0;
      } else {
        console.log("Player not ready.");
      }
    }

    function togglePlayPause() {
      if (!player) return;
      if (isPlaying) {
        player.pauseVideo();
      } else {
        player.playVideo();
      }
    }

    async function searchVideos() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;
      try {
        const response = await fetch('/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'query=' + encodeURIComponent(query)
        });
        const data = await response.json();
        document.getElementById('homeContainer').style.display = 'none';
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.style.display = 'flex';
        resultsContainer.innerHTML = '';
        const backBtn = document.createElement('button');
        backBtn.id = 'backBtn';
        backBtn.textContent = 'Back to Home';
        backBtn.onclick = showHome;
        resultsContainer.appendChild(backBtn);
        data.forEach(video => {
          const box = document.createElement('div');
          box.classList.add('search-box');
          box.innerHTML = `
            <img src="${video.thumbnail}" alt="${video.title}" onclick="playSong('${video.videoId}', '${video.title}')" />
            <h3>${video.title}</h3>
          `;
          resultsContainer.appendChild(box);
        });
      } catch (err) {
        console.error(err);
      }
    }

    function showHome() {
      document.getElementById('homeContainer').style.display = 'flex';
      const resultsContainer = document.getElementById('searchResults');
      resultsContainer.style.display = 'none';
      resultsContainer.innerHTML = '';
      document.getElementById('searchInput').value = '';
    }

    loadYouTubeAPI();
  </script>
</body>
</html>
